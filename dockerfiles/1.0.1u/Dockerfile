
# This file is automatically generated with Dockerfile.j2 as a template. Do not
# edit by hand, since your changes will be lost!
FROM buildpack-deps AS builder

# Create a shallow clone of the OpenSSL repository in the work directory,
# containing only the code of the specified version/tag.
WORKDIR /openssl
RUN git clone --branch OpenSSL_1_0_1u --depth 1 https://github.com/openssl/openssl.git .

# Compile OpenSSL
RUN ./config -fPIC no-asm zlib
RUN make

# Install to a temporary directory. The install command has changed through
# time. In 0.9.7e, the `install_sw` command was added, which does not install
# the docs. Release 1.1.0-pre3 changed the argument INSTALL_PREFIX to DESTDIR.
RUN make install_sw INSTALL_PREFIX=/tmp/package-dir

# Install the package to a new container, so we only have this OpenSSL version.
FROM debian
COPY --from=builder /tmp/package-dir /
RUN ldconfig

# Expose the default port
EXPOSE 4433
# This version does not put the openssl executable in the PATH. Creating
# a symlink to /usr/local/bin/openssl mimics the behavior from more recent
# versions.
RUN ln -s /usr/local/ssl/bin/openssl /usr/local/bin/openssl


# Copy the example key to the container
COPY example/server.key example/server.crt ./

# Start the server
CMD openssl s_server -key server.key -cert server.crt -accept 4433 -HTTP