{#
    This is the template from which all OpenSSL Dockerfiles are generated. As
    such, this is the file you should edit in order to make changes. We include
    a comment about this in the generated file.
#}
# This file is automatically generated with Dockerfile.j2 as a template. Do not
# edit by hand, since your changes will be lost!
FROM buildpack-deps AS builder

# Create a shallow clone of the OpenSSL repository in the work directory,
# containing only the code of the specified version/tag.
WORKDIR /openssl
RUN git clone --branch {{ tag }} --depth 1 https://github.com/openssl/openssl.git .

{% if version <= "0.9.7-beta4" -%}
# This version of OpenSSL specifies a CPU architecture that is no longer
# supported by most platforms, using the compiler flag `-m486`. Removing this
# flag will default to current architecture.
RUN find . -type f -exec sed -i 's/\-m486//g' {} +

{% endif -%}

# Compile OpenSSL
{%- if version < "0.9.7" %}
RUN ./config -fPIC no-asm

{%- else %}
RUN ./config -fPIC no-asm zlib

{%- endif %}
RUN make

# Install to a temporary directory. The install command has changed through
# time. In 0.9.7e, the `install_sw` command was added, which does not install
# the docs. Release 1.1.0-pre3 changed the argument INSTALL_PREFIX to DESTDIR.
{%- if version < "0.9.7e" %}
RUN make install INSTALL_PREFIX=/tmp/package-dir

{%- elif version < "1.1.0-pre3" and version != "1.1.0" %}
RUN make install_sw INSTALL_PREFIX=/tmp/package-dir

{%- else %}
RUN make install_sw DESTDIR=/tmp/package-dir

{%- endif %}

# Install the package to a new container, so we only have this OpenSSL version.
FROM debian
COPY --from=builder /tmp/package-dir /
RUN ldconfig

# Expose the default port
EXPOSE 4433

{%- if version < "1.1.0-pre3" and version != "1.1.0" %}
# This version does not put the openssl executable in the PATH. Creating
# a symlink to /usr/local/bin/openssl mimics the behavior from more recent
# versions.
RUN ln -s /usr/local/ssl/bin/openssl /usr/local/bin/openssl
{% endif %}

# Copy the example key to the container
COPY example/server.key example/server.crt ./

# Start the server
{%- if version < "0.9.7" %}
CMD openssl s_server -key server.key -cert server.crt -accept 4433 -WWW

{%- else %}
CMD openssl s_server -key server.key -cert server.crt -accept 4433 -HTTP

{%- endif %}
